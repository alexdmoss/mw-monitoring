groups:
  - name: kubernetes-apps
    rules:
      - alert: KubePodCrashLooping
        labels:
          group: mw-monitoring
          receiver: default
          severity: high
        annotations:
          dashboard: /d/not-implemented
          summary:
            Pod {{ $labels.namespace }}/{{ $labels.pod }} ({{ $labels.container
            }}) is restarting {{ printf "%.2f" $value }} times / 5 minutes.
        expr: |
          rate(kube_pod_container_status_restarts_total{job="kube-state-metrics"}[15m]) * 60 * 5 > 0
        for: 1h
      - alert: KubePodNotReady
        labels:
          group: mw-monitoring
          receiver: default
          severity: moderate
        annotations:
          dashboard: /d/not-implemented
          summary:
            Pod {{ $labels.namespace }}/{{ $labels.pod }} has been in a non-ready
            state for longer than an hour.
        expr: |
          sum by (namespace, pod) (kube_pod_status_phase{job="kube-state-metrics", phase=~"Failed|Pending|Unknown"}) > 0
        for: 1h
      - alert: KubeDeploymentGenerationMismatch
        labels:
          group: mw-monitoring
          receiver: default
          severity: low
        annotations:
          dashboard: /d/not-implemented
          summary:
            Deployment generation for {{ $labels.namespace }}/{{ $labels.deployment
            }} does not match, this indicates that the Deployment has failed but has
            not been rolled back.
        expr: |
          kube_deployment_status_observed_generation{job="kube-state-metrics"}
            !=
          kube_deployment_metadata_generation{job="kube-state-metrics"}
        for: 15m
      - alert: KubeDeploymentReplicasMismatch
        labels:
          group: mw-monitoring
          receiver: default
          severity: moderate
        annotations:
          dashboard: /d/not-implemented
          summary:
            Deployment {{ $labels.namespace }}/{{ $labels.deployment }} has not
            matched the expected number of replicas for longer than an hour.
        expr: |
          kube_deployment_spec_replicas{job="kube-state-metrics"}
            !=
          kube_deployment_status_replicas_available{job="kube-state-metrics"}
        for: 1h
      - alert: KubeStatefulSetReplicasMismatch
        labels:
          group: mw-monitoring
          receiver: default
          severity: moderate
        annotations:
          dashboard: /d/not-implemented
          summary:
            StatefulSet {{ $labels.namespace }}/{{ $labels.statefulset }} has
            not matched the expected number of replicas for longer than 15 minutes.
        expr: |
          kube_statefulset_status_replicas_ready{job="kube-state-metrics"}
            !=
          kube_statefulset_status_replicas{job="kube-state-metrics"}
        for: 15m
      - alert: KubeStatefulSetGenerationMismatch
        labels:
          group: mw-monitoring
          receiver: default
          severity: low
        annotations:
          dashboard: /d/not-implemented
          summary:
            StatefulSet generation for {{ $labels.namespace }}/{{ $labels.statefulset
            }} does not match, this indicates that the StatefulSet has failed but has
            not been rolled back.
        expr: |
          kube_statefulset_status_observed_generation{job="kube-state-metrics"}
            !=
          kube_statefulset_metadata_generation{job="kube-state-metrics"}
        for: 15m
      - alert: KubeStatefulSetUpdateNotRolledOut
        labels:
          group: mw-monitoring
          receiver: default
          severity: moderate
        annotations:
          dashboard: /d/not-implemented
          summary:
            StatefulSet {{ $labels.namespace }}/{{ $labels.statefulset }} update
            has not been rolled out.
        expr: |
          max without (revision) (
            kube_statefulset_status_current_revision{job="kube-state-metrics"}
              unless
            kube_statefulset_status_update_revision{job="kube-state-metrics"}
          )
            *
          (
            kube_statefulset_replicas{job="kube-state-metrics"}
              !=
            kube_statefulset_status_replicas_updated{job="kube-state-metrics"}
          )
        for: 15m
      - alert: KubeDaemonSetRolloutStuck
        labels:
          group: mw-monitoring
          receiver: default
          severity: moderate
        annotations:
          dashboard: /d/not-implemented
          summary:
            Only {{ $value }}% of the desired Pods of DaemonSet {{ $labels.namespace
            }}/{{ $labels.daemonset }} are scheduled and ready.
        expr: |
          kube_daemonset_status_number_ready{job="kube-state-metrics"}
            /
          kube_daemonset_status_desired_number_scheduled{job="kube-state-metrics"} * 100 < 100
        for: 15m
      - alert: KubeDaemonSetNotScheduled
        labels:
          group: mw-monitoring
          receiver: default
          severity: high
        annotations:
          dashboard: /d/not-implemented
          summary:
            "{{ $value }} Pods of DaemonSet {{ $labels.namespace }}/{{ $labels.daemonset
            }} are not scheduled."
        expr: |
          kube_daemonset_status_desired_number_scheduled{job="kube-state-metrics"}
            -
          kube_daemonset_status_current_number_scheduled{job="kube-state-metrics"} > 0
        for: 10m
      - alert: KubeCronJobRunning
        labels:
          group: mw-monitoring
          receiver: default
          severity: low
        annotations:
          dashboard: /d/not-implemented
          summary: CronJob {{ $labels.namespace }}/{{ $labels.cronjob }} is taking more than 1h to complete.
        expr: |
          time() - kube_cronjob_next_schedule_time{job="kube-state-metrics"} > 3600
        for: 1h
      - alert: KubeJobCompletion
        labels:
          group: mw-monitoring
          receiver: default
          severity: low
        annotations:
          dashboard: /d/not-implemented
          summary: Job {{ $labels.namespace }}/{{ $labels.job_name }} is taking more than one hour to complete.
        expr: |
          kube_job_spec_completions{job="kube-state-metrics"} - kube_job_status_succeeded{job="kube-state-metrics"}  > 0
        for: 1h
      - alert: KubeJobFailed
        labels:
          group: mw-monitoring
          receiver: default
          severity: moderate
        annotations:
          dashboard: /d/not-implemented
          summary: Job {{ $labels.namespace }}/{{ $labels.job_name }} failed to complete.
        expr: |
          kube_job_status_failed{job="kube-state-metrics"}  > 0
        for: 1h
